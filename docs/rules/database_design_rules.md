# DB設計のルール

DB設計におけるルールを以下に記載する。

以下のルールは原則であり、個々のエンティティの事情によっては逸脱を認める。

ただし、その場合は設計時に他メンバーにも相談すること。

また、意図的に逸脱した場合、後世の開発者に伝わるよう、コメントや設計成果物などに意図がわかる説明を記載すること。（何をしているのか？ではなく、何故そうしたのか？を明記する）

## ネーミング

- エンティティの物理名称を定義したら、プログラム上も含め画面の表示名以外は原則同一の単語をベースに使用する  (user=account=customer=clientすべて同じデータ内容ということのないよう)
- 特定エンティティに対する明細項目、履歴管理対象となるヒストリカルテーブルには固定のサフィックスをつける

#### 共通ネーミングルール

| ネーミングルール | 説明 |
| ------- | ---- |
| {エンティティ名}_items | 特定のエンティティを正規化した場合の子テーブル(購入伝票に対する購入伝票明細など)に対しての標準的なネーミング。正規化していても該当エンティティに対して特定の専門用語が存在する場合はそちらを優先してよい |
| {エンティティ名}_history | 特定のエンティティに対する履歴テーブル、または、エンティティそのモノをより日、まで日を持つ時系列データとして定義した場合の標準的なネーミング。該当エンティティに対して特定の専門用語が存在する場合はそちらを優先してよい |

## データの削除方針

- 原則テーブルからの物理削除を前提とする
- 物理削除できない要件がある場合、(例えば着任後、退職に至ったユーザーに対するリレーションなど)はライフサイクルに合わせたフラグ管理の設計、単純なバックアップ、断面コピーであれば別テーブルへの移動等を設計する

## トランザクション制御と排他制御

- エラー発生時のデータの整合性を担保する為、DB更新を伴う処理にはトランザクション制御をおこなう
- 悲観的ロックを使った排他制御(トランザクション制御やるが前提)はケースに応じて実施(更新前の取得内容に応じて整合とる必要せいがあるケースではやる)
- 楽観的排他ロジックなどDBのトランザクション制御外の排他制御については、要件発生に応じて都度検討とする

## 共通仕様カラム

以下のカラムは共通仕様とし全テーブル同一の名称（またはネーミングルール）を使用する。ただし、全テーブルに必ずこれらのカラムがないといけないということではなく、必要に応じて作成すること。

| カラム | 物理項目名 | 型桁 | 説明 |
| ---- | ---- | ---- |  ---- |
| ID | id | uuid | 各テーブルのサロゲートキー Ectoのデフォルト項目から[Ecto.ULID](https://hexdocs.pm/ecto_ulid/Ecto.ULID.html)を使用した発番にカスタマイズ |
| 作成日時 | inserted_at | timestamp | レコードの作成日時 NotNull Ectoのデフォルト項目 |
| 更新日時 | updated_at | timestamp | レコードの更新日時 NotNull Ectoのデフォルト項目 |
| 表示順 | position | integer | レコードの表示順 NotNull 小さいものを先に表示 |

## Ecto.Enumの利用

いわゆる列挙型のカラムは、Ecto.Enumを利用してマッピングすること。

[Ecto.Enum](https://hexdocs.pm/ecto/Ecto.Enum.html)

また下記を基本方針とします。

- string型の利用を最初に考える。
- 並び替えなどの用途（大小比較）がある場合において、integer型を使う判断をする。

意味もなくintegerを使うと数値を決めるという無用な設計が必要になるためです。

## INDEXの設計

最適なINDEXはプログラム実装からのSELECTの要件次第で変わるため、テーブルの設計時には主キーINDEX、ユニークINDEX以外は設計しない。
対象のデータ利用する各機能担当により随時追加するものとする。

## 外部キーのマイグレーション

関連テーブルのIDをカラムとして持つ場合、外部キーを必ず作成すること。

外部キーを作成する上で、データ削除はDBではなくアプリ側の制御下に置くため、以下のようにマイグレーションファイル中の `references` に `on_delete: :nothing` を指定する。

```elixir
add :skill_panel_id, references(:skill_panels, on_delete: :nothing), null: false
```

なお、 `mix phx.gen.***` でマイグレーションファイルを作成すると、自動で `on_delete: :nothing` が指定される。

## 基準時刻

Datetime型項目の基準時刻はDB上は、すべてUTCとし必要に応じてコントローラーやビュー上でJSTに変換する。
