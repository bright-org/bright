# DB設計のルール

DB設計におけるルールを以下に記載する。  

以下のルールは原則であり、個々のエンティティの事情によっては逸脱を認める。

ただし、その場合は設計時に他メンバーにも相談すること。  

また、意図的に逸脱した場合、後世の開発者に伝わるよう、コメントや設計成果物などに意図がわかる説明を記載すること。  （何をしているのか？ではなく、何故そうしたのか？を明記する）

## ネーミング

- エンティティの物理名称を定義したら、プログラム上も含め画面の表示名以外は原則同一の単語をベースに使用する  (user=account=customer=clientすべて同じデータ内容ということのないよう)

- 単語1語の名称を使用する場合は、のちの検索容易性に注意する  
(user、client、tokenなど将来的に容易に重複しそうな命名は避ける、必要な場合はxxx_clientなど複数単語にする)

- システムシード値や運用で登録されるマスターテーブル、履歴管理対象となるヒストリカルテーブルには固定のプレフィックス、サフィックスをつける  
(mst_xxx、xxx_hisotry)

  #### 共通ネーミングルール

    | ネーミングルール | 説明 |
    | ------- | ---- | 
    | mst_{エンティティ名} | シード値のみで構成される、運用登録データのみで構成される所謂マスターテーブルに対するネーミング。 シード値が存在しても、ユーザ操作によってデータが発生するトランザクションテーブルは含めない  | 
    | {エンティティ名}_details | 特定のエンティティを正規化した場合の子テーブル(購入伝票に対する購入伝票明細など)に対しての標準的なネーミング。正規化していても該当エンティティに対して特定の専門用語が存在する場合はそちらを優先してよい | 
    | {エンティティ名}_hisotry | 特定のエンティティに対する履歴テーブル、または、エンティティそのモノをより日、まで日を持つ時系列データとして定義した場合の標準的なネーミング。該当エンティティに対して特定の専門用語が存在する場合はそちらを優先してよい | 

## 論理削除と物理削除

- 論理削除にするか物理削除にするかはエンティティの特性に応じて明確に決める。（どっちか原則きめる？）
- 論理削除の場合、deleted_atカラムを定義する。Nullではない場合論理削除扱いとし、削除時にシステム時刻を設定する。

## 排他制御

- 原則悲観的ロックは実装しない？
- 原則楽観的ロックは実装しない？

## 共通仕様カラム

以下のカラムは共通仕様とし全テーブル同一の名称（またはネーミングルール）を使用する。

| カラム | 物理項目名 | 型桁 | 説明 |
| ---- | ---- | ---- |  ---- |
| ID | {テーブル物理名単数形}_id | bigint(20) | 各テーブルのサロゲートキー Ectoのデフォルト項目 |
| 作成日時 | inserted_at | timestamp | レコードの作成日時 NotNull Ectoのデフォルト項目 |
| 更新日時 | updated_at | timestamp | レコードの更新日時 NotNull Ectoのデフォルト項目 |
| 削除日時 | deleted_at | timestamp | レコードの削除日時 Nullの場合未削除 |

## INDEXの設計

最適なINDEXはプログラム実装からのSELECTの要件次第で変わるため、テーブルの設計時には主キーINDEX以外は設計しない。
対象のデータ利用する各機能担当により随時追加するものとする。

## 基準時刻

Datetime型項目の基準時刻はDB上は、すべてUTCとし必要に応じてコントローラーやビュー上でJSTに変換する